/**
 ******************************************************************************
 *  file           : victron.h
 *  brief          : Defines and stuff for Victron devices
 ******************************************************************************
 *  Copyright (C) 2024 Florian Brandner
 *
 * Some stuff taken from Fabian Schmidts esphome component. See
 * https://github.com/Fabian-Schmidt/esphome-victron_ble
 *
 */

#ifndef __VICTRON_H_
#define __VICTRON_H_

#ifdef __cplusplus
extern "C" {
#endif

#include "stdint.h"

#define MANUFACTURER_RTYPE 0x10
#define MANUFACTURER_RLEN 2
#define MANUFACTURER_ID 0x02E1

// Bluetooth LE Frame
typedef struct __attribute__((packed)) {
  uint16_t manu_id;           // Manufacturer ID
  uint8_t manu_record_type;   // Should always be 0x10
  uint8_t manu_record_length; // Should be 0x02
  uint16_t product_id;        // 2-Byte product ID
  uint8_t record_type;        // Record type
  uint8_t data_counter_lsb;   // Data counter / Nonce
  uint8_t data_counter_msb;   // Data counter / Nonce
  uint8_t encryption_key_0;   // Byte 0 of encryption key
  uint8_t encData;            // Start of encrypted data
} VICTRON_BLE_RECORD;

// Encrypted Data: Solar Charger Record (0x01)
typedef struct {
  uint8_t dev_state;
  uint8_t charger_error;
  int16_t bat_voltage; // Voltage in 0.01V
  int16_t bat_current; // Current in 0.1A
  uint16_t yield;      // todays yield in 0.01kWh
  uint16_t pv_power;   // Power in W
  uint16_t load;       // Load in 0.1A (only 9 bits)
  uint8_t res[4];      // Unused
} victron_solar_charger_t;

// Encrypted Data: Battery Monitor Record (0x02)
typedef struct {
  uint16_t ttg;             // TTG in 1min
  int16_t bat_voltage;      // Voltage in 0.01V
  uint16_t alarm;           // Alarm reason
  uint16_t volt_temp;       // Aux+Mid voltages, temperature
  uint8_t aux_in : 2;       // 2 bits aux in
  int32_t bat_current : 22; // Current in 0.1A
  int32_t consumed_ah : 20; // Consumed in 0.1Ah
  uint16_t soc : 10;        // SOC in 0.1%
  uint16_t reserved : 10;   // Unused
} victron_battery_monitor_t;

// Encrypted Data: Device States
#define VREG_STATE_OFF 0x00,
#define VREG_STATE_LOW_POWER 0x01
#define VREG_STATE_FAULT 0x02
#define VREG_STATE_BULK 0x03
#define VREG_STATE_ABSORPTION 0x04
#define VREG_STATE_FLOAT 0x05
#define VREG_STATE_STORAGE 0x06
#define VREG_STATE_EQUALIZE 0x07
#define VREG_STATE_PASSTHRU 0x08
#define VREG_STATE_INVERTING 0x09
#define VREG_STATE_ASSISTING 0x0A
#define VREG_STATE_POWER_SUPPLY 0x0B
#define VREG_STATE_SUSTAIN 0xF4
#define VREG_STATE_STARTING_UP 0xF5
#define VREG_STATE_REPEATED_ABSORPTION 0xF6
#define VREG_STATE_AUTO_EQUALIZE 0xF7
#define VREG_STATE_BATTERY_SAFE 0xF8
#define VREG_STATE_TEST 0xFB
#define VREG_STATE_HUB1 0xFC
#define VREG_STATE_NOT_AVAILABLE 0xFF

// Encrypted Data: Error Codes
#define VREG_ERR_NO_ERROR 0
#define VREG_ERR_BAT_TEMPERATURE_HIGH 1
#define VREG_ERR_BAT_VOLTAGE_HIGH 2
#define VREG_ERR_BAT_TEMP_SENS_MISW_P 3
#define VREG_ERR_BAT_TEMP_SENS_MISW_N 4
#define VREG_ERR_BAT_TEMP_SENS_DISC 5
#define VREG_ERR_BAT_VOLT_SENS_MISW_P 6
#define VREG_ERR_BAT_VOLT_SENS_MISW_N 7
#define VREG_ERR_BAT_VOLT_SENS_DISC 8
#define VREG_ERR_BAT_VOLT_WLOSS 9
#define VREG_ERR_CHARGER_TEMP_HIGH 17
#define VREG_ERR_CHARGER_OVER_CURRENT 18
#define VREG_ERR_CHARGER_CURR_REVERSE 19
#define VREG_ERR_CHARGER_BULK_TIME 20
#define VREG_ERR_CHARGER_CURRENT_SENSOR 21
#define VREG_ERR_CHARGER_TEMP_SENS_MISW 22
#define VREG_ERR_CHARGER_TEMP_SENS_DISC 23
#define VREG_ERR_CHARGER_FAN 24
#define VREG_ERR_CHARGER_FAN_OVR_CURR 25
#define VREG_ERR_CHARGER_TERM_OVERHEATED26
#define VREG_ERR_CHARGER_SHORT_CIRCUIT 27
#define VREG_ERR_INPUT_VOLTAGE 33
#define VREG_ERR_INPUT_CURRENT 34
#define VREG_ERR_INPUT_POWER 35
#define VREG_ERR_INPUT_REV_POLARITY 36
#define VREG_ERR_INPUT_VOL_ABSENT 37
#define VREG_ERR_LOAD_TEMP_HIGH 49
#define VREG_ERR_LOAD_OVER_VOLTAGE 50
#define VREG_ERR_LOAD_OVER_CURRENT 51
#define VREG_ERR_LOAD_CURR_REVERSE 52
#define VREG_ERR_LOAD_OVER_POWER 53
#define VREG_ERR_LINK_DEV_MISSING 65
#define VREG_ERR_LINK_DEV_INCOMPAT 66
#define VREG_ERR_LINK_BMS_CON_LOST 67
#define VREG_ERR_NVS_W_ERROR 113
#define VREG_ERR_CPU_TEMPERATURE 114
#define VREG_ERR_SETTINGS_LOST 116
#define VREG_ERR_INCOMP_FW 117
#define VREG_ERR_INCOMP_HW 118
#define VREG_ERR_FACTORY_SETTINGS 119
#define VREG_ERR_NOT_AVAILABLE 0xFF

// The Record Types
#define VREG_RTYPE_TEST_RECORD 0x00
#define VREG_RTYPE_SOLAR_CHARGER 0x01
#define VREG_RTYPE_BATTERY_MONITOR 0x02
#define VREG_RTYPE_INVERTER 0x03
#define VREG_RTYPE_DCDC_CONVERTER 0x04
#define VREG_RTYPE_SMART_LITHIUM 0x05
#define VREG_RTYPE_INVERTER_RS 0x06
#define VREG_RTYPE_GX_DEVICE 0x07
#define VREG_RTYPE_AC_CHARGER 0x08
#define VREG_RTYPE_SMART_BATTERY_PROTECT 0x09
#define VREG_RTYPE_LYNX_SMART_BMS 0x0A
#define VREG_RTYPE_MULTI_RS 0x0B
#define VREG_RTYPE_VE_BUS 0x0C
#define VREG_RTYPE_DC_ENERGY_METER 0x0D
#define VREG_RTYPE_ORION_XS 0x0F

// The Product IDs
#define PID_BLUESOLAR_MPPT_100_15 0XA043
#define PID_BLUESOLAR_MPPT_100_20 0XA066
#define PID_BLUESOLAR_MPPT_100_20_48V 0XA067
#define PID_BLUESOLAR_MPPT_100_30_REV2 0XA04A
#define PID_BLUESOLAR_MPPT_100_50_REV2 0XA049
#define PID_BLUESOLAR_MPPT_150_100 0XA047
#define PID_BLUESOLAR_MPPT_150_35_REV2 0XA04B
#define PID_BLUESOLAR_MPPT_150_45 0XA04D
#define PID_BLUESOLAR_MPPT_150_45_REV2 0XA06F
#define PID_BLUESOLAR_MPPT_150_60 0XA04E
#define PID_BLUESOLAR_MPPT_150_60_REV2 0XA070
#define PID_BLUESOLAR_MPPT_150_70 0XA046
#define PID_BLUESOLAR_MPPT_150_70_REV2 0XA071
#define PID_BLUESOLAR_MPPT_150_85 0XA04F
#define PID_BLUESOLAR_MPPT_75_10 0XA04C
#define PID_BLUESOLAR_MPPT_75_15 0XA042
#define PID_BLUESOLAR_MPPT_VE_CAN_150_100 0XA10F
#define PID_BLUESOLAR_MPPT_VE_CAN_250_100 0XA113
#define PID_BLUESOLAR_MPPT_VE_CAN_250_70 0XA112
#define PID_BMV_700 0X0203
#define PID_BMV_700H 0X0205
#define PID_BMV_702 0X0204
#define PID_PHOENIX_INVERTER_12V_1200VA_120V 0XA279
#define PID_PHOENIX_INVERTER_12V_1200VA_230V 0XA271
#define PID_PHOENIX_INVERTER_12V_1600VA_230V 0XA281
#define PID_PHOENIX_INVERTER_12V_2000VA_230V 0XA291
#define PID_PHOENIX_INVERTER_12V_250VA_120V 0XA239
#define PID_PHOENIX_INVERTER_12V_250VA_230V 0XA231
#define PID_PHOENIX_INVERTER_12V_3000VA_230V 0XA2A1
#define PID_PHOENIX_INVERTER_12V_375VA_120V 0XA249
#define PID_PHOENIX_INVERTER_12V_375VA_230V 0XA241
#define PID_PHOENIX_INVERTER_12V_500VA_120V 0XA259
#define PID_PHOENIX_INVERTER_12V_500VA_230V 0XA251
#define PID_PHOENIX_INVERTER_12V_800VA_120V 0XA269
#define PID_PHOENIX_INVERTER_12V_800VA_230V 0XA261
#define PID_PHOENIX_INVERTER_24V_1200VA_120V 0XA27A
#define PID_PHOENIX_INVERTER_24V_1200VA_230V 0XA272
#define PID_PHOENIX_INVERTER_24V_1600VA_230V 0XA282
#define PID_PHOENIX_INVERTER_24V_2000VA_230V 0XA292
#define PID_PHOENIX_INVERTER_24V_250VA_120V 0XA23A
#define PID_PHOENIX_INVERTER_24V_250VA_230V 0XA232
#define PID_PHOENIX_INVERTER_24V_3000VA_230V 0XA2A2
#define PID_PHOENIX_INVERTER_24V_375VA_120V 0XA24A
#define PID_PHOENIX_INVERTER_24V_375VA_230V 0XA242
#define PID_PHOENIX_INVERTER_24V_500VA_120V 0XA25A
#define PID_PHOENIX_INVERTER_24V_500VA_230V 0XA252
#define PID_PHOENIX_INVERTER_24V_800VA_120V 0XA26A
#define PID_PHOENIX_INVERTER_24V_800VA_230V 0XA262
#define PID_PHOENIX_INVERTER_48V_1200VA_120V 0XA27C
#define PID_PHOENIX_INVERTER_48V_1200VA_230V 0XA274
#define PID_PHOENIX_INVERTER_48V_1600VA_230V 0XA284
#define PID_PHOENIX_INVERTER_48V_2000VA_230V 0XA294
#define PID_PHOENIX_INVERTER_48V_250VA_120V 0XA23C
#define PID_PHOENIX_INVERTER_48V_250VA_230V 0XA234
#define PID_PHOENIX_INVERTER_48V_3000VA_230V 0XA2A4
#define PID_PHOENIX_INVERTER_48V_375VA_120V 0XA24C
#define PID_PHOENIX_INVERTER_48V_375VA_230V 0XA244
#define PID_PHOENIX_INVERTER_48V_500VA_120V 0XA25C
#define PID_PHOENIX_INVERTER_48V_500VA_230V 0XA254
#define PID_PHOENIX_INVERTER_48V_800VA_120V 0XA26C
#define PID_PHOENIX_INVERTER_48V_800VA_230V 0XA264
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_12_30 0XA344
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_12_30_3 0XA345
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_12_50 0XA340
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_12_50_3 0XA341
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_24_16 0XA346
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_24_16_3 0XA347
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_24_50 0XA342
#define PID_PHOENIX_INVERTER_SMART_IP43_CHARGER_24_50_3 0XA343
#define PID_SMARTSHUNT_500A_50MV 0XA389
#define PID_SMARTSOLAR_MPPT_100_15 0XA055
#define PID_SMARTSOLAR_MPPT_100_20 0XA05F
#define PID_SMARTSOLAR_MPPT_100_20_48V 0XA060
#define PID_SMARTSOLAR_MPPT_100_30 0XA056
#define PID_SMARTSOLAR_MPPT_100_50 0XA057
#define PID_SMARTSOLAR_MPPT_150_100_REV2 0XA059
#define PID_SMARTSOLAR_MPPT_150_100_REV3 0XA06E
#define PID_SMARTSOLAR_MPPT_150_35 0XA058
#define PID_SMARTSOLAR_MPPT_150_45 0XA061
#define PID_SMARTSOLAR_MPPT_150_45_REV2 0XA06A
#define PID_SMARTSOLAR_MPPT_150_60 0XA062
#define PID_SMARTSOLAR_MPPT_150_60_REV2 0XA06B
#define PID_SMARTSOLAR_MPPT_150_70 0XA063
#define PID_SMARTSOLAR_MPPT_150_70_REV2 0XA06C
#define PID_SMARTSOLAR_MPPT_150_85_REV2 0XA05A
#define PID_SMARTSOLAR_MPPT_150_85_REV3 0XA06D
#define PID_SMARTSOLAR_MPPT_250_100 0XA050
#define PID_SMARTSOLAR_MPPT_250_100_REV2 0XA065
#define PID_SMARTSOLAR_MPPT_250_45 0XA05E
#define PID_SMARTSOLAR_MPPT_250_60 0XA05D
#define PID_SMARTSOLAR_MPPT_250_60_REV2 0XA068
#define PID_SMARTSOLAR_MPPT_250_70 0XA05B
#define PID_SMARTSOLAR_MPPT_250_70_REV2 0XA069
#define PID_SMARTSOLAR_MPPT_250_85 0XA05C
#define PID_SMARTSOLAR_MPPT_250_85_REV2 0XA064
#define PID_SMARTSOLAR_MPPT_75_10 0XA054
#define PID_SMARTSOLAR_MPPT_75_15 0XA053
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_100 0XA106
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_100_REV2 0XA10E
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_45 0XA103
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_60 0XA104
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_70 0XA102
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_70_REV2 0XA10C
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_85 0XA105
#define PID_SMARTSOLAR_MPPT_VE_CAN_150_85_REV2 0XA10D
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_100 0XA10B
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_100_REV2 0XA115
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_45 0XA107
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_60 0XA108
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_70 0XA109
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_70_REV2 0XA114
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_85 0XA10A
#define PID_SMARTSOLAR_MPPT_VE_CAN_250_85_REV2 0XA116

#ifdef __cplusplus
}
#endif

#endif // __VICTRON_H_
